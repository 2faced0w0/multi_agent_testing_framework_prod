<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MATF Dashboard</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div id="app">
    <header>
      <h1>Multi‑Agent Testing Framework</h1>
      <span class="badge">Dark · Minimal</span>
    </header>
    <div id="dashboard-error" class="alert error hidden"></div>
    <div class="toolbar-row">
      <div id="last-refresh" class="hint">Last refresh: (pending)</div>
      <div id="global-loading" class="global-loading hidden">
        <div class="spinner sm"></div>
        <span>Loading…</span>
      </div>
    </div>

    <section class="card">
      <h2>Watch a GitHub Repository</h2>
      <form id="watch-form">
        <section class="grid dashboard-lists">
          <header class="app-header">
            <h1>Multi-Agent Testing Framework Dashboard</h1>
            <div class="header-actions">
              <button id="themeToggle" class="btn sm" type="button" aria-label="Toggle theme">Toggle Theme</button>
              <button id="densityToggle" class="btn sm density-toggle" type="button" aria-label="Toggle density">Compact</button>
              <button id="openTokenModal" class="btn sm" type="button">Set API Token</button>
            </div>
          </header>
        <input id="branch" type="text" placeholder="branch (default: main)" />
        <button type="submit">Add & Queue Analysis</button>
      </form>
      <p class="hint">We only accept public GitHub URLs. Set ALLOWED_REPOS for stricter control.</p>
    </section>

    <section class="stats-bar card">
      <div id="totals" class="stats loading-block"><div class="spinner sm"></div></div>
    </section>

    <section class="card watchers-section">
      <div class="section-head">
        <h3>Watchers</h3>
        <form id="watchers-filter" class="filter-form compact">
          <input id="q" type="text" placeholder="search repo" class="flex-1" />
          <select id="status">
            <option value="">all statuses</option>
            <option value="active">active</option>
            <option value="pending">pending</option>
            <option value="error">error</option>
          </select>
          <button type="submit" class="btn-secondary">Filter</button>
          <button type="button" id="reset" class="btn-secondary">Reset</button>
        </form>
      </div>
      <ul id="watchers" class="data-list loading-block"><li><div class="spinner sm"></div></li></ul>
    </section>

    <section class="grid dashboard-lists">
      <div class="card">
        <h3>Executions</h3>
        <ul id="executions" class="data-list loading-block"><li><div class="spinner sm"></div></li></ul>
      </div>
      <div class="card">
        <h3>Reports</h3>
        <div class="scroll-section" id="reportsScroll">
          <ul id="reportsList" class="data-list mini-list"></ul>
        </div>
      </div>
      <div class="card">
        <h3>Test Cases</h3>
        <div class="scroll-section" id="testsScroll">
          <ul id="testsList" class="data-list mini-list"></ul>
        </div>
      </div>
      <div class="card live-col">
        <h3>Live Status</h3>
        <div id="runtime" class="space-y-2">
          <div class="row-spaced mb-8">
            <button id="reset-queues" class="btn-secondary" title="Clear queues">Reset Queues</button>
            <span id="reset-queues-status" class="hint"></span>
          </div>
          <div id="queue-stats" class="text-sm"></div>
          <div id="exec-counts" class="text-sm"></div>
          <div class="grid two-col gap-8 small-cols">
            <div>
              <h4>Running</h4>
              <ul id="running-list" class="mini-list"></ul>
            </div>
            <div>
              <h4>Queued</h4>
              <ul id="queued-list" class="mini-list"></ul>
            </div>
          </div>
        </div>
      </div>
      <div class="card card-debug debug-col">
        <h3 class="debug-header">Debug Log</h3>
        <div class="section-head" style="display:flex; align-items:center; gap:12px;">
          <h2 style="flex:1; margin:0; font-size:14px;">Debug Log</h2>
          <button id="debugToggle" type="button" class="btn sm debug-toggle" aria-expanded="false">Show</button>
        </div>
        <div id="debug-log" class="debug-log">
          <div class="hint">Network / dashboard diagnostics will appear here.</div>
        </div>
      </div>
    </section>

    <footer>
      <span class="chip ok">ok</span>
      <span class="chip warn">warn</span>
      <span class="chip err">err</span>
      <a href="/metrics" target="_blank">Prometheus metrics</a>
      <a href="/api/v1/system/health" target="_blank">API health</a>
    </footer>
  </div>
  <!-- External script (no inline JS to satisfy strict CSP). If cache busting needed, server can append ?v=envStamp. -->
  <script src="/app.js" defer></script>
    <!-- Token Modal for JWT acquisition -->
    <div id="token-modal" class="modal hidden">
      <div class="modal-body">
        <h3>Authentication Required</h3>
        <p class="modal-text">Repeated 401 responses detected. Provide a JWT (payload with <code>roles:['admin']</code>) or disable GUI auth for development (<code>GUI_AUTH_ENABLED=false</code>).</p>
        <textarea id="token-input" class="token-input" placeholder="Paste Bearer token here"></textarea>
        <div class="modal-actions">
          <button id="token-cancel" class="btn-secondary">Cancel</button>
          <button id="token-save" class="btn-primary">Save Token</button>
        </div>
        <div id="token-status" class="hint token-status"></div>
      </div>
    </div>
</body>
</html>
